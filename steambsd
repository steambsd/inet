#!/bin/sh
############################################
### Simple installation Steam on FreeBSD ###
############################################
### Config
# choose driver for your PC, it may be: nvidia, amdgpu, radeon, intel or vesa (vesa for virtual machine)
DRIVER='vesa'
echo "We have DRIVER = $DRIVER"
# user with wheel group
AZER=`ls /home`
echo "We have USER = $AZER"
# basic
sysrc -f /boot/loader.conf autoboot_delay=2
sysrc -f /boot/loader.conf beastie_disable=YES
# update
env PAGER=cat freebsd-update fetch
freebsd-update install
env ASSUME_ALWAYS_YES=YES pkg bootstrap
env ASSUME_ALWAYS_YES=YES pkg update -f
# packages for user privilegies
pkg ins -y sudo bash
echo '%wheel ALL=(ALL) NOPASSWD: ALL' >> /usr/local/etc/sudoers
pw usermod $AZER -s /usr/local/bin/bash
# user for steam
pw useradd steam -m
# linux
sysrc linux_enable=YES
sysrc linux64_enable=YES
kldload linux
kldload linux64
# tuning
echo 'kern.coredump=0' >> /etc/sysctl.conf
sysctl kern.coredump=0
# packages for desktop environment
pkg ins -y xorg
pkg ins -y slim
pkg ins -y lxde-meta
# packages for wine
pkg ins -y i386-wine
pkg ins -y winetricks
pkg ins -y wine-mono
pkg ins -y wine-gecko
# packages for linux
pkg ins -y linux-steam-utils
# packages for comfort
pkg ins -y leafpad
pkg ins -y chromium
pkg ins -y vlc
pkg ins -y simplescreenrecorder
# slim customization
sysrc dbus_enable=YES
sysrc hald_enable=YES
sysrc slim_enable=YES
service dbus start
service hald start
service slim start
echo "default_user        $AZER" >> /usr/local/etc/slim.conf
echo "auto_login          yes" >> /usr/local/etc/slim.conf
echo 'focus_password      yes' >> /usr/local/etc/slim.conf
# lxde customization
# ----------------------------------------------------------------------------------------
echo 'ck-launch-session dbus-launch --exit-with-session startlxde' >> /home/$AZER/.xinitrc
echo 'startlxde' >> /home/$AZER/.xinitrc
cat << EOF >> /usr/local/etc/polkit-1/rules.d/50-default.rules
polkit.addRule(function (action, subject) {
  if ((action.id == "org.freedesktop.consolekit.system.restart" ||
      action.id == "org.freedesktop.consolekit.system.stop")
      && subject.isInGroup("wheel")) {
    return polkit.Result.YES;
  }
});
EOF
cat << EOF >> /etc/crontab
@reboot root /bin/echo 'startlxde' > /home/$AZER/.xinitrc
EOF
#autostart
cat << EOF >> /usr/local/etc/xdg/lxsession/LXDE/autostart 
@lxterminal -e ~/autoconfig
EOF
# ----------------------------------------------------------------------------------------
# copy files
cp steam-linux /home/${AZER}/.steam-linux
cp steam-wine /home/${AZER}/.steam-wine
cp autoconfig /home/${AZER}/ 
cp wall.jpg /home/${AZER}/
cp check /home/${AZER}/
cp utils /home/${AZER}/
# set permission
chown -R ${AZER}:wheel /home/${AZER}/
# startx
su $AZER -c 'startx'


